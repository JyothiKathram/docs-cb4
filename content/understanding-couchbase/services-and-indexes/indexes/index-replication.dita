<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_axj_xtr_zz2">
  
  <title>
    Index Replication and Availability
  </title>
  
  <shortdesc>
    <i>Secondary Indexes</i> can be replicated between nodes, ensuring availability.
  </shortdesc>
  
  <body>
    
    <section id="section_tnn_hbz_zz2">
      
      <title>
        Replicating Secondary Indexes
      </title>
      
      <p>
        Secondary indexes can be replicated across cluster-nodes,
        to ensure availability. Additionally, whenever original and replica copies
        are both available, incoming queries are load-balanced across them: should one or more copies become unavailable,
        all requests are rerouted to one of those copies that remain
        available, without the intervention of application or administrator required. 
      </p>
      
      <p>
        Index-replicas can be
        created with the N1QL <codeph>CREATE INDEX</codeph> statement. Note that whenever
        a given number of index-replicas is specified for creation, the number must be less than the number of cluster-nodes
        currently running the 
        <xref href="../../services-and-indexes/services/index-service.dita" scope="local" format="dita">Index Service</xref>.
        If it is not, the index-creation fails. Note also that if, following creation of the maximum number of copies, 
        the number of nodes running the Index Service 
        decreases, replacement index-replicas will be automatically created on any nodes that are
        subsequently added to the cluster and are 
        configured to run the Index Service, until
        the required number of index-replicas again exists for each replicated index.
      </p>
      
      <p>
        Index-replicas can be created in any of the following ways:
      </p>
      
      <p>
        
      </p>
      
      <ul>
        <li>
          Specifying, by means of the <codeph>WITH</codeph> clause, the destination nodes. In the following example,
          an index with two replicas is created. The active index is on <codeph>node1</codeph>, and the replicas
          are on <codeph>node2</codeph> and <codeph>node3</codeph>:
          
          <codeblock id="nodes-example2">CREATE INDEX productName_index1 ON bucket_name(productName, ProductID) 
            WHERE type="product" USING GSI 
            WITH {"nodes":["node1:8091", "node2:8091", "node3:8091"]};</codeblock>
          
          <p>
            
          </p>
        </li>
        
        <li>
          Specifying <i>no</i> destination nodes; but specifying instead, by means of the <codeph>WITH</codeph> clause
          and the <codeph>num_replica</codeph> attribute,
          only the <i>number</i> of replicas required. The replicas are automatically distributed across those nodes of the
          cluster that are running the Index Service: the distribution-pattern is based on a calculation of the
          best-assured availability of the index, given the number and disposition of Index-Service nodes across
          defined server-groups.
          
          <p>
            In the following example, an index is created with two replicas, with no destination-nodes
            specified:
          </p>
          
          <codeblock>CREATE INDEX productName_index1 ON bucket_name(productName, ProductID) 
            WHERE type="product" USING GSI 
            WITH {"num_replica": 2};</codeblock>
          
          <p>
            Note that if
            both <codeph>nodes</codeph> and <codeph>num_replica</codeph> are specified in the <codeph>WITH</codeph>
            clause, the specified number of nodes must be <i>one greater</i> than <codeph>num_replica</codeph>.
          </p>
          
          <p>
            
          </p>
        </li>
        
        <li>
          Specifying a number of index-replicas to be created by the Index Service whenever <codeph>CREATE INDEX</codeph> is
          invoked. The default is 0. If the default is changed to, say, 2, creation of a single index is henceforth
          accompanied by the creation of 2 replicas, which are automatically distributed across the nodes of the cluster
          running the Index Service. No explicit specification within the <codeph>CREATE INDEX</codeph> statement is
          required. 
          
          <p>
            With appropriate authorization, this default can be changed by means of the <codeph>curl</codeph> command, as follows:
          </p>
          
          <codeblock>curl -u &lt;username>:&lt;password> &lt;host>:9102/settings -d "{\"indexer.settings.num_replica\": &lt;num_replicas>}"</codeblock>
          
          <p>
            Note that whenever explicit specification of replica-numbers is made within the <codeph>CREATE INDEX</codeph> statement, this 
            explicit specification takes
            precedence over the current default.
          </p>
          
          
          <p>
            
          </p>
        </li>
        
        
      </ul>
      
      <p>
        For further information on using N1QL, see
        <xref href="../../../sdk/n1ql-query.dita" scope="local" format="dita">Querying with N1QL</xref>.
      </p>
        
    
    </section>
  </body>
</topic>
